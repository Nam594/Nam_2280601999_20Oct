<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload ·∫¢nh - User Avatar & Multiple Images</title>
    <style>
      /* Simplified layout for upload page */
      body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fb; margin:0; padding:20px; }
      .container { max-width: 820px; margin: 24px auto; background:#fff; padding:18px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
      h1 { font-size:1.2rem; margin:0 0 12px 0; color:#111; }
      .card { border: 1px solid #eee; padding:14px; border-radius:6px; margin-bottom:12px; }
      .card h2 { font-size:1rem; margin:0 0 8px 0; }
      .form-group { margin-bottom:10px; }
      label { display:block; font-weight:600; margin-bottom:6px; }
      input[type="text"] { width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; }
      .file-input-label { display:inline-block; padding:8px 10px; background:#1976d2; color:#fff; border-radius:4px; cursor:pointer; }
      .file-name { color:#666; font-size:0.85rem; margin-top:6px; }
      .btn { display:block; width:100%; padding:10px; margin-top:8px; background:#1976d2; color:#fff; border:none; border-radius:6px; font-weight:600; cursor:pointer; }
      .preview-container { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
      .preview-item img { width:120px; height:80px; object-fit:cover; border-radius:6px; }
      .avatar-preview { width:100px; height:100px; border-radius:50%; overflow:hidden; margin:8px 0; display:none; }
      .message { margin-top:8px; padding:8px; border-radius:6px; display:none; }
      .message.success { background:#e6ffed; color:#065f3b; display:block; }
      .message.error { background:#ffecec; color:#6b0b0b; display:block; }
      .loading { display:none; margin-top:8px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üé® Upload ·∫¢nh Avatar & Multiple Images</h1>

      <div class="cards-container">
        <!-- Card 1: Upload Avatar -->
        <div class="card">
          <h2>üì∏ Upload Avatar (ƒêƒÉng nh·∫≠p required)</h2>

          <form id="avatarForm">
            <div class="form-group">
              <label for="token">JWT Token:</label>
              <input
                type="text"
                id="token"
                name="token"
                placeholder="Nh·∫≠p Bearer token..."
                required
              />
            </div>

            <div class="form-group">
              <label>Ch·ªçn ·∫£nh avatar:</label>
              <div class="file-input-wrapper">
                <input type="file" id="avatarFile" accept="image/*" required />
                <label for="avatarFile" class="file-input-label">
                  üìÇ Ch·ªçn ·∫£nh avatar
                </label>
              </div>
              <div id="avatarFileName" class="file-name"></div>
            </div>

            <div class="avatar-preview" id="avatarPreview">
              <img id="avatarPreviewImg" src="" alt="Avatar preview" />
            </div>

            <button type="submit" class="btn">‚¨ÜÔ∏è Upload Avatar</button>
          </form>

          <div class="loading" id="avatarLoading">
            <div class="spinner"></div>
            <p>ƒêang upload...</p>
          </div>

          <div id="avatarMessage" class="message"></div>
        </div>

        <!-- Card 2: Upload Multiple Images -->
        <div class="card">
          <h2>üñºÔ∏è Upload Nhi·ªÅu ·∫¢nh (ƒêƒÉng nh·∫≠p required)</h2>

          <form id="multipleForm">
            <div class="form-group">
              <label for="tokenMultiple">JWT Token:</label>
              <input
                type="text"
                id="tokenMultiple"
                name="token"
                placeholder="Nh·∫≠p Bearer token..."
                required
              />
            </div>

            <div class="form-group">
              <label>Ch·ªçn nhi·ªÅu ·∫£nh:</label>
              <div class="file-input-wrapper">
                <input
                  type="file"
                  id="multipleFiles"
                  accept="image/*"
                  multiple
                  required
                />
                <label for="multipleFiles" class="file-input-label">
                  üìÇ Ch·ªçn nhi·ªÅu ·∫£nh
                </label>
              </div>
              <div id="multipleFileNames" class="file-name"></div>
            </div>

            <div class="preview-container" id="multiplePreview"></div>

            <button type="submit" class="btn">‚¨ÜÔ∏è Upload T·∫•t C·∫£</button>
          </form>

          <div class="loading" id="multipleLoading">
            <div class="spinner"></div>
            <p>ƒêang upload...</p>
          </div>

          <div id="multipleMessage" class="message"></div>
        </div>
      </div>
    </div>

    <script>
      // Avatar Upload
      const avatarForm = document.getElementById("avatarForm");
      const avatarFile = document.getElementById("avatarFile");
      const avatarFileName = document.getElementById("avatarFileName");
      const avatarPreview = document.getElementById("avatarPreview");
      const avatarPreviewImg = document.getElementById("avatarPreviewImg");
      const avatarMessage = document.getElementById("avatarMessage");
      const avatarLoading = document.getElementById("avatarLoading");

      // Preview avatar when selected
      avatarFile.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          avatarFileName.textContent = `ƒê√£ ch·ªçn: ${file.name}`;

          const reader = new FileReader();
          reader.onload = function (e) {
            avatarPreviewImg.src = e.target.result;
            avatarPreview.style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      });

      // Submit avatar
      avatarForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const token = document.getElementById("token").value;
        const file = avatarFile.files[0];

        if (!file) {
          showMessage(avatarMessage, "Vui l√≤ng ch·ªçn file!", "error");
          return;
        }

        const formData = new FormData();
        formData.append("avatar", file);

        try {
          avatarLoading.classList.add("active");
          avatarMessage.style.display = "none";

          const response = await fetch("/users/upload-avatar", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const data = await response.json();

          avatarLoading.classList.remove("active");

          if (data.success) {
            showMessage(
              avatarMessage,
              `‚úÖ Upload th√†nh c√¥ng! Avatar URL: ${data.data.avatarURL}`,
              "success"
            );
          } else {
            showMessage(
              avatarMessage,
              `‚ùå L·ªói: ${data.message || "Upload th·∫•t b·∫°i"}`,
              "error"
            );
          }
        } catch (error) {
          avatarLoading.classList.remove("active");
          showMessage(avatarMessage, `‚ùå L·ªói: ${error.message}`, "error");
        }
      });

      // Multiple Files Upload
      const multipleForm = document.getElementById("multipleForm");
      const multipleFiles = document.getElementById("multipleFiles");
      const multipleFileNames = document.getElementById("multipleFileNames");
      const multiplePreview = document.getElementById("multiplePreview");
      const multipleMessage = document.getElementById("multipleMessage");
      const multipleLoading = document.getElementById("multipleLoading");

      let selectedFiles = [];

      // Preview multiple files when selected
      multipleFiles.addEventListener("change", function (e) {
        selectedFiles = Array.from(e.target.files);
        displayMultiplePreview();
      });

      function displayMultiplePreview() {
        multipleFileNames.textContent = `ƒê√£ ch·ªçn: ${selectedFiles.length} file(s)`;
        multiplePreview.innerHTML = "";

        selectedFiles.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            const previewItem = document.createElement("div");
            previewItem.className = "preview-item";
            previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${
              index + 1
            }">
                        <button type="button" class="remove-btn" onclick="removeFile(${index})">√ó</button>
                    `;
            multiplePreview.appendChild(previewItem);
          };
          reader.readAsDataURL(file);
        });
      }

      function removeFile(index) {
        selectedFiles.splice(index, 1);
        displayMultiplePreview();

        // Update file input
        const dt = new DataTransfer();
        selectedFiles.forEach((file) => dt.items.add(file));
        multipleFiles.files = dt.files;
      }

      // Submit multiple files
      multipleForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const token = document.getElementById("tokenMultiple").value;

        if (selectedFiles.length === 0) {
          showMessage(
            multipleMessage,
            "Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 file!",
            "error"
          );
          return;
        }

        const formData = new FormData();
        selectedFiles.forEach((file) => {
          formData.append("files", file);
        });

        try {
          multipleLoading.classList.add("active");
          multipleMessage.style.display = "none";

          const response = await fetch("/files/upload-multiple", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const data = await response.json();

          multipleLoading.classList.remove("active");

          if (data.success) {
            showMessage(
              multipleMessage,
              `‚úÖ Upload th√†nh c√¥ng ${data.data.length} file(s)!`,
              "success"
            );

            // Clear preview
            selectedFiles = [];
            multiplePreview.innerHTML = "";
            multipleFileNames.textContent = "";
            multipleForm.reset();
          } else {
            showMessage(
              multipleMessage,
              `‚ùå L·ªói: ${data.message || "Upload th·∫•t b·∫°i"}`,
              "error"
            );
          }
        } catch (error) {
          multipleLoading.classList.remove("active");
          showMessage(multipleMessage, `‚ùå L·ªói: ${error.message}`, "error");
        }
      });

      // Helper function
      function showMessage(element, text, type) {
        element.textContent = text;
        element.className = `message ${type}`;
        element.style.display = "block";
      }
    </script>
  </body>
</html>
